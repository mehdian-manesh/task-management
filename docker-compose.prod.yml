services:
  task-management-backend:
    container_name: task-management-backend
    image: task-management-backend
    environment:
      - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY}
      - DATABASE_URL=postgresql://postgres:${DB_PASSWORD}@task-management-db:5432/taskmanagement
      - TZ=Asia/Tehran
    depends_on:
      - task-management-db
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request, sys; r = urllib.request.urlopen('http://localhost:8000/health/'); sys.exit(0 if r.status == 200 else 1)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  task-management-frontend:
    container_name: task-management-frontend
    image: task-management-frontend
    environment:
      - REACT_APP_BACKEND_URL=https://${DOMAIN:-localhost}:${HTTPS_PORT:-443}/api
      - WATCHPACK_POLLING=true
      - BASELINE_BROWSER_MAPPING_IGNORE_OLD_DATA=1
      - BROWSERSLIST_IGNORE_OLD_DATA=1
      - NODE_OPTIONS=--no-warnings --no-deprecation
      - TZ=Asia/Tehran
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1/ >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  task-management-reverse-proxy:
    image: caddy:2-alpine
    container_name: task-management-reverse-proxy
    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - task-management-frontend
      - task-management-backend
    environment:
      - DOMAIN=${DOMAIN}
    healthcheck:
      test: ["CMD", "pidof", "caddy"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  task-management-db:
    image: postgres:16-alpine
    container_name: task-management-db
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=taskmanagement
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${DB_PASSWORD:-lodjfq243rDGFHSFgasdfgasdfashasdffgsdfgh}
      - TZ=Asia/Tehran
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d taskmanagement"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped

volumes:
  postgres_data:
  caddy_data:
  caddy_config: